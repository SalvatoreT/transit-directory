---
import { DateTime } from "luxon";

interface Props {
  departureTime: number;
  delay: number | null | undefined;
  timezone: string;
  agencyId: string;
  tripId: string;
  stopSequence: number;
}

const { departureTime, delay, timezone, agencyId, tripId, stopSequence } =
  Astro.props;

const href = `/a/${agencyId}/t/${tripId}?stop=${stopSequence}`;

const stopMidnight = DateTime.now().setZone(timezone).startOf("day");
const depTime = stopMidnight.plus({ seconds: departureTime });

const isNextDay = depTime.day !== stopMidnight.day;
const timeDisplay = depTime.toFormat("h:mm a") + (isNextDay ? " (+1)" : "");

let statusClass = "scheduled";
let timeLabel = timeDisplay;

if (delay != null) {
  const delayMin = Math.round(delay / 60);
  if (delayMin > 0) {
    timeLabel += ` (+${delayMin})`;
    statusClass = "delayed";
  } else if (delayMin < 0) {
    timeLabel += ` (${delayMin})`;
    statusClass = "early";
  } else {
    statusClass = "on-time";
  }
}
---

<a href={href} class="time-link">
  <span class={`time-pill ${statusClass}`}>{timeLabel}</span>
</a>

<style>
  .time-link {
    text-decoration: none;
    color: inherit;
  }

  .time-link:hover {
    opacity: 0.8;
  }

  .time-pill {
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    background: #f0f0f0;
    color: #555;
    white-space: nowrap;
    display: inline-block;
  }

  .delayed {
    background: #ffebee;
    color: #c62828;
  }

  .early {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .on-time {
    background: #e8f5e9;
    color: #2e7d32;
  }
</style>
