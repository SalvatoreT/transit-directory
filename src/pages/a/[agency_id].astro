---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { getLiveEntry, getLiveCollection } from "astro:content";

const { agency_id } = Astro.params;

if (!agency_id) {
  return Astro.redirect("/404");
}

// 1. Get Agency and Active Feed Version
const { entry: agencyEntry, error: agencyError } = await getLiveEntry(
  "agencies",
  agency_id,
);

if (agencyError || !agencyEntry) {
  return new Response(`Agency not found: ${agency_id}`, { status: 404 });
}

const { agency_name, feed_version_id } = agencyEntry.data;

// 2. Get Parent Stops
const { entries: stopsEntries, error: stopsError } = await getLiveCollection(
  "stops",
  { feed_version_id, is_parent: true },
);

if (stopsError) {
  console.error("Error fetching stops:", stopsError);
}

const stops = (stopsEntries || [])
  .map((s) => s.data)
  .sort((a, b) => a.stop_name.localeCompare(b.stop_name));
---

<Layout>
  <main>
    <h1>{agency_name} <span class="agency-id">({agency_id})</span></h1>
    <p class="subtitle">Select a Stop</p>

    <div class="stops-grid">
      {
        stops.map((stop) => (
          <a href={`/a/${agency_id}/s/${stop.stop_id}`} class="stop-card-link">
            <div class="stop-card">
              <h2>{stop.stop_name}</h2>
              <span class="chevron">â€º</span>
            </div>
          </a>
        ))
      }
    </div>
  </main>
</Layout>

<style>
  main {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    font-family: system-ui, sans-serif;
  }

  h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .agency-id {
    color: #666;
    font-size: 1.5rem;
    font-weight: normal;
  }

  .subtitle {
    color: #666;
    margin-bottom: 2rem;
  }

  .stops-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .stop-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .stop-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition:
      transform 0.1s ease,
      box-shadow 0.1s ease;
  }

  .stop-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .stop-card h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .chevron {
    font-size: 1.5rem;
    color: #999;
  }
</style>
