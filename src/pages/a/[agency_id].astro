---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { getLiveEntry } from "astro:content";
import AgencyRoutesView from "../../components/AgencyRoutesView.astro";
import AgencyStopsView from "../../components/AgencyStopsView.astro";

const { agency_id } = Astro.params;

if (!agency_id) {
  return Astro.redirect("/404");
}

// 1. Get Agency and Active Feed Version
const { entry: agencyEntry, error: agencyError } = await getLiveEntry(
  "agencies",
  agency_id,
);

if (agencyError || !agencyEntry) {
  return new Response(`Agency not found: ${agency_id}`, { status: 404 });
}

const { agency_name, feed_version_id, agency_pk } = agencyEntry.data;

const view =
  Astro.url.searchParams.get("view") === "stops" ? "stops" : "routes";

const title = `${agency_name} (${agency_id}) - Transit Directory`;
const description = `View active routes and stops for ${agency_name}.`;
---

<Layout title={title} description={description}>
  <main>
    <div class="header">
      <a href="/" class="back-link">‚Üê Back to Transit Directory</a>
      <h1>{agency_name} <span class="agency-id">({agency_id})</span></h1>
    </div>

    <div class="view-toggle">
      <a
        href={`/a/${agency_id}`}
        class={`toggle-btn ${view === "routes" ? "active" : ""}`}>Routes</a
      >
      <a
        href={`/a/${agency_id}?view=stops`}
        class={`toggle-btn ${view === "stops" ? "active" : ""}`}>Stops</a
      >
    </div>

    <p class="subtitle">
      {view === "routes" ? "Active Routes" : "Select a Stop"}
    </p>

    {
      view === "routes" ? (
        <AgencyRoutesView
          feed_version_id={feed_version_id}
          agency_id={agency_id}
          agency_pk={agency_pk}
        />
      ) : (
        <AgencyStopsView
          feed_version_id={feed_version_id}
          agency_id={agency_id}
        />
      )
    }
  </main>
</Layout>

<style>
  main {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    font-family: system-ui, sans-serif;
  }

  .header {
    margin-bottom: 2rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 2rem;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 1rem;
    color: #0066cc;
    text-decoration: none;
    font-weight: 500;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  h1 {
    font-size: 2.5rem;
    margin: 0;
  }

  .agency-id {
    color: #666;
    font-size: 1.5rem;
    font-weight: normal;
  }

  .subtitle {
    color: #666;
    margin-bottom: 1.5rem;
  }

  .view-toggle {
    display: inline-flex;
    background: #f0f0f0;
    padding: 4px;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .toggle-btn {
    text-decoration: none;
    color: #666;
    padding: 0.5rem 1.5rem;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .toggle-btn:hover {
    color: #333;
  }

  .toggle-btn.active {
    background-color: #fff;
    color: #000;
    font-weight: 600;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
</style>
